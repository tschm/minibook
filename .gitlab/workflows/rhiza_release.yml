# This file is part of the jebel-quant/rhiza repository
# (https://github.com/jebel-quant/rhiza).
#
# Release Workflow for Python Packages with Optional Devcontainer Publishing (GitLab CI)
#
# This workflow implements a secure, maintainable release pipeline with distinct phases:
#
# ðŸ“‹ Pipeline Phases:
#   1. ðŸ” Validate Tag - Check tag format and ensure release doesn't already exist
#   2. ðŸ—ï¸ Build - Build Python package with Hatch (if [build-system] is defined in pyproject.toml
#   3. ðŸ“ Draft Release - Create draft GitLab release with build artifacts
#   4. ðŸš€ Publish to PyPI - Publish package using token or custom feed
#   5. ðŸ³ Publish Devcontainer - Build and publish devcontainer image (conditional)
#   6. âœ… Finalize Release - Publish the GitLab release with links
#
# ðŸ³ Devcontainer Publishing:
#   - Only occurs when PUBLISH_DEVCONTAINER variable is set to "true"
#   - Requires .devcontainer directory to exist
#   - Uses the release tag (e.g., v1.2.3) as the image tag
#   - Image name: {registry}/{group}/{repository}/devcontainer
#   - Registry defaults to registry.gitlab.com (override with DEVCONTAINER_REGISTRY variable)
#
# ðŸš€ PyPI Publishing:
#   - Skipped if no dist/ artifacts exist
#   - Skipped if pyproject.toml contains "Private :: Do Not Upload"
#   - Uses PYPI_TOKEN for authentication
#   - For custom feeds, use PYPI_REPOSITORY_URL and PYPI_TOKEN variables
#
# ðŸ“„ Requirements:
#   - pyproject.toml with top-level version field (for Python packages)
#   - PYPI_TOKEN variable for PyPI publishing
#   - PUBLISH_DEVCONTAINER variable set to "true" (for devcontainer publishing)
#   - .devcontainer/devcontainer.json file (for devcontainer publishing)
#
# âœ… To Trigger:
#   Create and push a version tag:
#     git tag v1.2.3
#     git push origin v1.2.3

workflow:
  rules:
    - if: $CI_COMMIT_TAG =~ /^v.*/

variables:
  RELEASE_TAG: $CI_COMMIT_TAG

.release_validate_tag:
  stage: .pre
  image: alpine:latest
  script:
    - apk add --no-cache git curl jq
    - |
      TAG="$CI_COMMIT_TAG"
      echo "Validating tag: $TAG"

      # Check if release already exists (using GitLab API)
      RELEASE_EXISTS=$(curl --header "PRIVATE-TOKEN: $CI_JOB_TOKEN" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases/${TAG}" \
        -s -o /dev/null -w "%{http_code}")

      if [ "$RELEASE_EXISTS" = "200" ]; then
        echo "âŒ Release '$TAG' already exists. Please use a new tag."
        exit 1
      fi

      echo "âœ… Tag validation passed"
  artifacts:
    reports:
      dotenv: release.env

release:build:
  stage: build
  needs:
    - job: .release_validate_tag
      optional: true
  image: ghcr.io/astral-sh/uv:0.9.18-python3.12-bookworm
  before_script:
    - git fetch --tags
  script:
    - |
      export UV_EXTRA_INDEX_URL="${UV_EXTRA_INDEX_URL}"
      uv sync --all-extras --all-groups --frozen

      # Verify version matches tag
      if [ -f "pyproject.toml" ]; then
        TAG_VERSION="${CI_COMMIT_TAG#v}"
        PROJECT_VERSION=$(uv version --short)

        if [ "$PROJECT_VERSION" != "$TAG_VERSION" ]; then
          echo "âŒ Version mismatch: pyproject.toml has '$PROJECT_VERSION' but tag is '$TAG_VERSION'"
          exit 1
        fi
        echo "âœ… Version verified: $PROJECT_VERSION matches tag"
      fi

      # Detect buildable Python package
      if [ -f "pyproject.toml" ] && grep -q '^\[build-system\]' pyproject.toml; then
        echo "ðŸ“¦ Building package..."
        uvx hatch build
      else
        echo "â­ï¸ No buildable package detected, skipping build"
        mkdir -p dist  # Create empty dist directory
      fi
  artifacts:
    paths:
      - dist/
    expire_in: 1 day

release:draft:
  stage: deploy
  needs:
    - job: release:build
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      TAG="$CI_COMMIT_TAG"

      # Create draft release using GitLab API
      RELEASE_NOTES="Release $TAG"

      curl --request POST \
        --header "PRIVATE-TOKEN: $CI_JOB_TOKEN" \
        --data "tag_name=$TAG" \
        --data "name=$TAG" \
        --data "description=$RELEASE_NOTES" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases"

      echo "âœ… Draft release created"

release:pypi:
  stage: deploy
  needs:
    - job: release:build
      artifacts: true
    - job: release:draft
  image: python:3.12
  before_script:
    - pip install twine
  script:
    - |
      # Check if dist contains artifacts and not marked as private
      if [ ! -d "dist" ] || [ -z "$(ls -A dist)" ]; then
        echo "âš ï¸ No dist/ artifacts found. Skipping PyPI publish."
        exit 0
      fi

      if grep -R "Private :: Do Not Upload" pyproject.toml; then
        echo "â­ï¸ Package marked as private. Skipping PyPI publish."
        exit 0
      fi

      # Publish to PyPI
      if [ -n "$PYPI_REPOSITORY_URL" ]; then
        echo "ðŸ“¦ Publishing to custom repository: $PYPI_REPOSITORY_URL"
        twine upload --repository-url "$PYPI_REPOSITORY_URL" \
          --username __token__ --password "$PYPI_TOKEN" \
          --skip-existing dist/*
      else
        echo "ðŸ“¦ Publishing to PyPI"
        twine upload --username __token__ --password "$PYPI_TOKEN" \
          --skip-existing dist/*
      fi

      echo "âœ… Published to PyPI"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v.*/
      when: on_success
  allow_failure: false

release:devcontainer:
  stage: deploy
  needs:
    - job: release:build
    - job: release:draft
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
  before_script:
    - apk add --no-cache bash jq curl nodejs npm git
    - npm install -g @devcontainers/cli
  script:
    - |
      # Check if devcontainer should be published
      if [ "${PUBLISH_DEVCONTAINER}" != "true" ] || [ ! -d ".devcontainer" ]; then
        echo "â­ï¸ Skipping devcontainer publish (PUBLISH_DEVCONTAINER not true or .devcontainer missing)"
        exit 0
      fi

      echo "ðŸš€ Building and publishing devcontainer image"

      # Set registry
      REGISTRY="${DEVCONTAINER_REGISTRY:-registry.gitlab.com}"
      echo "Using registry: $REGISTRY"

      # Login to container registry
      echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$REGISTRY"

      # Get lowercase repository path
      REPO_PATH_LC=$(echo "$CI_PROJECT_PATH" | tr '[:upper:]' '[:lower:]')

      # Get image name component
      if [ -z "$DEVCONTAINER_IMAGE_NAME" ]; then
        REPO_NAME_LC=$(echo "$CI_PROJECT_NAME" | tr '[:upper:]' '[:lower:]')
        REPO_NAME_SANITIZED=$(echo "$REPO_NAME_LC" | sed 's/^[._-]*//; s/[._-][._-]*/-/g')
        IMAGE_NAME="$REPO_NAME_SANITIZED/devcontainer"
      else
        IMAGE_NAME="$DEVCONTAINER_IMAGE_NAME"
      fi

      # Validate image name
      if ! echo "$IMAGE_NAME" | grep -qE '^[a-z0-9]+([._-][a-z0-9]+)*(/[a-z0-9]+([._-][a-z0-9]+)*)*$'; then
        echo "âŒ Invalid image name component: $IMAGE_NAME"
        exit 1
      fi

      FULL_IMAGE_NAME="$REGISTRY/$REPO_PATH_LC/$IMAGE_NAME"
      echo "âœ… Image name: $FULL_IMAGE_NAME:$CI_COMMIT_TAG"

      # Build and push devcontainer
      devcontainer build \
        --workspace-folder . \
        --config .devcontainer/devcontainer.json \
        --image-name "$FULL_IMAGE_NAME:$CI_COMMIT_TAG" \
        --push

      echo "DEVCONTAINER_IMAGE=$FULL_IMAGE_NAME:$CI_COMMIT_TAG" >> release.env
      echo "âœ… Devcontainer published"
  artifacts:
    reports:
      dotenv: release.env
  rules:
    - if: $CI_COMMIT_TAG =~ /^v.*/
      when: on_success
  allow_failure: false

release:finalize:
  stage: .post
  needs:
    - job: release:build
    - job: release:pypi
      optional: true
    - job: release:devcontainer
      optional: true
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq python3
  script:
    - |
      TAG="$CI_COMMIT_TAG"
      RELEASE_BODY=""

      # Add PyPI link if published
      if [ -f "pyproject.toml" ]; then
        PACKAGE_NAME=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['name'])" 2>/dev/null || echo "")
        if [ -n "$PACKAGE_NAME" ]; then
          VERSION="${TAG#v}"
          if [ -z "$PYPI_REPOSITORY_URL" ]; then
            RELEASE_BODY="${RELEASE_BODY}\n\n### PyPI Package\n\n[$PACKAGE_NAME](https://pypi.org/project/$PACKAGE_NAME/$VERSION/)"
          else
            RELEASE_BODY="${RELEASE_BODY}\n\n### Custom Feed Package\n\n[$PACKAGE_NAME]($PYPI_REPOSITORY_URL)"
          fi
        fi
      fi

      # Add Devcontainer link if published
      if [ -n "$DEVCONTAINER_IMAGE" ]; then
        RELEASE_BODY="${RELEASE_BODY}\n\n### Devcontainer Image\n\n\`$DEVCONTAINER_IMAGE\`"
      fi

      # Update release with additional information
      curl --request PUT \
        --header "PRIVATE-TOKEN: $CI_JOB_TOKEN" \
        --data "description=Release $TAG$RELEASE_BODY" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases/${TAG}"

      echo "âœ… Release finalized"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v.*/
      when: on_success
