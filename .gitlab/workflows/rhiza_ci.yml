# This file is part of the jebel-quant/rhiza repository
# (https://github.com/jebel-quant/rhiza).
#
# Workflow: Continuous Integration (GitLab CI)
#
# Purpose: Run tests on multiple Python versions to ensure compatibility.
#
# Trigger: On push and merge requests to main/master branches.

ci:test:
  stage: test
  image: ghcr.io/astral-sh/uv:0.9.30-bookworm
  parallel:
    matrix:
      - PYTHON_VERSION: ["3.11", "3.12", "3.13", "3.14"]
  variables:
    GIT_LFS_SKIP_SMUDGE: "0"
  before_script:
    - apt-get update && apt-get install -y git-lfs
    - git lfs pull
  script:
    - echo "Testing with Python $PYTHON_VERSION"
    - export UV_EXTRA_INDEX_URL="${UV_EXTRA_INDEX_URL}"
    - uv venv --python ${PYTHON_VERSION}
    - make -f .rhiza/rhiza.mk test

  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

ci:docs-coverage:
  stage: test
  image: ghcr.io/astral-sh/uv:0.9.30-bookworm
  script:
    - export UV_EXTRA_INDEX_URL="${UV_EXTRA_INDEX_URL}"
    - uv venv
    - make -f .rhiza/rhiza.mk docs-coverage

  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH
