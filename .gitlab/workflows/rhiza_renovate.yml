# Renovate - Automated dependency updates
#
# This workflow runs Renovate to check for dependency updates and create
# merge requests automatically.
#
# Required variables:
#   - RENOVATE_TOKEN: GitLab Project/Group Access Token with api, read_repository,
#                     write_repository scopes. Must be a Project Access Token (not PAT).
#
# Triggers:
#   - Scheduled pipelines (set up in GitLab CI/CD > Schedules)
#   - Manual trigger via web UI
#

renovate:
  stage: .pre
  image: renovate/renovate:latest
  variables:
    # GitLab platform configuration
    RENOVATE_PLATFORM: gitlab
    RENOVATE_ENDPOINT: $CI_API_V4_URL
    # Git author for commits (required for Project Access Tokens)
    RENOVATE_GIT_AUTHOR: "Renovate Bot <renovate-bot@gitlab.com>"
    # Note: GITHUB_COM_TOKEN is set via CI/CD variables (Settings > CI/CD > Variables)
    # Logging - set to debug for troubleshooting
    LOG_LEVEL: info
  script:
    - |
      if [ -z "$RENOVATE_TOKEN" ]; then
        echo "Error: RENOVATE_TOKEN is not set"
        echo "Please create a Project Access Token with api, read_repository, write_repository scopes"
        echo "and add it as a CI/CD variable named RENOVATE_TOKEN"
        exit 1
      fi
    - |
      echo "Running Renovate for $CI_PROJECT_PATH"
      echo "GitLab API endpoint: $CI_API_V4_URL"
      echo "Token length: ${#RENOVATE_TOKEN}"
      echo "Token prefix: $(echo $RENOVATE_TOKEN | cut -c1-10)..."
    - |
      echo "GITHUB_COM_TOKEN length: ${#GITHUB_COM_TOKEN}"
      echo "GITHUB_COM_TOKEN prefix: $(echo $GITHUB_COM_TOKEN | cut -c1-4)"
    - |
      echo "Testing GitHub token with curl..."
      curl -s -o /dev/null -w "GitHub API Status: %{http_code}\n" \
        -H "Authorization: token $GITHUB_COM_TOKEN" \
        "https://api.github.com/rate_limit"
    - |
      echo "Testing GitLab token with curl..."
      curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" \
        --header "PRIVATE-TOKEN: $RENOVATE_TOKEN" \
        "$CI_API_V4_URL/version"
    - renovate --autodiscover=false "$CI_PROJECT_PATH"
  rules:
    # Run on scheduled pipelines
    - if: $CI_PIPELINE_SOURCE == "schedule" && $RENOVATE_ENABLED != "false"
      when: always
    # Allow manual trigger from web UI
    - if: $CI_PIPELINE_SOURCE == "web" && $RENOVATE_RUN == "true"
      when: always
    # Never run on regular pushes or MRs
    - when: never
