# This file is part of the jebel-quant/rhiza repository
# (https://github.com/jebel-quant/rhiza).
#
# Workflow: Book (GitLab CI)
#
# Purpose: This workflow builds and deploys comprehensive documentation for the project.
#          It combines API documentation, test coverage reports, test results, and
#          interactive notebooks into a single GitLab Pages site.
#
# Trigger: This workflow runs on every push to the main or master branch
#
# Components:
#   - ðŸ““ Process Marimo notebooks
#   - ðŸ“– Generate API documentation with pdoc
#   - ðŸ§ª Run tests and generate coverage reports
#   - ðŸš€ Deploy combined documentation to GitLab Pages

pages:
  stage: deploy
  needs: []
  image: ghcr.io/astral-sh/uv:0.9.28-bookworm
  variables:
    GIT_LFS_SKIP_SMUDGE: "0"
  before_script:
    - apt-get update && apt-get install -y git-lfs make
    - git lfs pull
    - export UV_EXTRA_INDEX_URL="${UV_EXTRA_INDEX_URL}"
  script:
    - |
      # Check if PUBLISH_COMPANION_BOOK is set (defaults to allowing deployment)
      if [ "${PUBLISH_COMPANION_BOOK:-true}" = "false" ]; then
        echo "PUBLISH_COMPANION_BOOK is set to false, skipping deployment"
        exit 0
      fi

      # Build the book
      make book

      # GitLab Pages expects artifacts in the "public" directory
      # Move _book to public for GitLab Pages
      mv _book public

      # Create .nojekyll file if not present
      touch public/.nojekyll
  artifacts:
    paths:
      - public
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"
